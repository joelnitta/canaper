<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CANAPE example • canaper</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="CANAPE example">
<meta property="og:description" content="canaper">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">canaper</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/canape.html">CANAPE example</a>
    </li>
    <li>
      <a href="../articles/how-many-rand.html">How many randomizations?</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Parallel computing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/joelnitta/canaper/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="canape_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>CANAPE example</h1>
                        <h4 class="author">Joel H. Nitta</h4>
            
            <h4 class="date">23 October, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/joelnitta/canaper/blob/master/vignettes/canape.Rmd"><code>vignettes/canape.Rmd</code></a></small>
      <div class="hidden name"><code>canape.Rmd</code></div>

    </div>

    
    
<p>CANAPE stands for “Categorical Analysis of Neo- And Paleo-Endemism”, and provides insight into the evolutionary processes underlying endemism <span class="citation">(Mishler et al. 2014)</span>. The idea is basically that endemic regions may be so because either they contain range-restricted parts of a phylogeny that have unusually long branch lengths (paleoendemism), or unusually short branch lengths (neoendemism), or a mixture of both. Paleoendemism may reflect old lineages that have survived extinctions; neoendemism may reflect recently speciated lineages that have not yet dispersed.</p>
<p>This vignette replicates the <a href="https://doi.org/10.1038/ncomms5473">analysis of Mishler et al. 2014</a>, where CANAPE was originally defined.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>Start by loading <code>canaper</code> and some other packages we will use for this vignette:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joelnitta/canaper">canaper</a></span><span class="op">)</span> <span class="co"># This package :)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/">ape</a></span><span class="op">)</span> <span class="co"># For handling phylogenetic trees</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span> <span class="co"># For parallel computing</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/collectivemedia/tictoc">tictoc</a></span><span class="op">)</span> <span class="co"># For timing things</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span> <span class="co"># For composing mult-part plots</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="co"># For data-wrangling and plotting</span></code></pre></div>
</div>
<div id="dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#dataset" class="anchor"></a>Dataset</h2>
<p>The <code>canaper</code> package comes with the dataset used in <span class="citation">Mishler et al. (2014)</span>. Let’s load the data into memory:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">acacia</span><span class="op">)</span></code></pre></div>
<p>The <code>acacia</code> dataset is a list including two items. The first, <code>phy</code>, is a phylogeny of <em>Acacia</em> species in Australia:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acacia</span><span class="op">$</span><span class="va">phy</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Phylogenetic tree with 510 tips and 509 internal nodes.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Tip labels:</span>
<span class="co">#&gt;   Pararchidendron_pruinosum, Paraserianthes_lophantha, adinophylla, semicircinalis, aphanoclada, inaequilatera, ...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Rooted; includes branch lengths.</span></code></pre></div>
<p>The second, <code>comm</code>, is a community dataframe with species as columns and rows as sites. The row names (sites) correspond to the centroids of 50 x 50 km grid cells covering Australia. The community matrix is too large to print out in its entirety, so we will just take a look at the first 8 rows and columns<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">acacia</span><span class="op">$</span><span class="va">comm</span><span class="op">)</span>
<span class="co">#&gt; [1] 3037  506</span>
<span class="va">acacia</span><span class="op">$</span><span class="va">comm</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>
<span class="co">#&gt;                     abbreviata acanthaster acanthoclada acinacea aciphylla</span>
<span class="co">#&gt; '-1025000:-1825000'          0           0            0        0         0</span>
<span class="co">#&gt; '-1025000:-1875000'          0           0            0        0         0</span>
<span class="co">#&gt; '-1025000:-1925000'          0           0            0        0         0</span>
<span class="co">#&gt; '-1025000:-1975000'          0           0            0        0         0</span>
<span class="co">#&gt; '-1025000:-2025000'          0           0            0        0         0</span>
<span class="co">#&gt; '-1025000:-2075000'          0           0            0        0         0</span>
<span class="co">#&gt; '-1025000:-2125000'          0           0            0        0         0</span>
<span class="co">#&gt; '-1025000:-2225000'          0           0            0        0         0</span>
<span class="co">#&gt;                     acoma acradenia acrionastes</span>
<span class="co">#&gt; '-1025000:-1825000'     0         0           0</span>
<span class="co">#&gt; '-1025000:-1875000'     0         0           0</span>
<span class="co">#&gt; '-1025000:-1925000'     0         0           0</span>
<span class="co">#&gt; '-1025000:-1975000'     0         0           0</span>
<span class="co">#&gt; '-1025000:-2025000'     0         0           0</span>
<span class="co">#&gt; '-1025000:-2075000'     0         0           0</span>
<span class="co">#&gt; '-1025000:-2125000'     0         0           0</span>
<span class="co">#&gt; '-1025000:-2225000'     0         0           0</span></code></pre></div>
</div>
<div id="randomization-test" class="section level2">
<h2 class="hasAnchor">
<a href="#randomization-test" class="anchor"></a>Randomization test</h2>
<p>There are many metrics that describe the phylogenetic diversity of ecological communities. But how do we know if a given metric is statistically significant? One way is with a randomization test. The general process is:</p>
<ol style="list-style-type: decimal">
<li>Generate a set of random communities</li>
<li>Calculate the metric of interest for each random community</li>
<li>Compare the observed values to the random values</li>
</ol>
<p>Observed values that are in the extremes (e.g, the top or lower 5% for a one-sided test, or either the top or bottom 2.5% for a two-sided test) would be considered significantly more or less diverse than random.</p>
<p>The main purpose of <code>canaper</code> is to perform these randomization tests.</p>
<p><code>canaper</code> generates random communities using the <a href="https://CRAN.R-project.org/package=vegan"><code>vegan</code> package</a>. There are a large number of pre-defined randomization algorithms available in <code>vegan</code><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, as well as an option to provide a user-defined algorithm. Selecting the appropriate algorithm is not trivial, and can greatly influence results<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. For details about the pre-defined algorithms, see <code><a href="https://rdrr.io/pkg/vegan/man/commsim.html">vegan::commsim()</a></code>.</p>
<p>This example also demonstrates one of the strengths of <code>canaper</code>: the ability to run randomizations in parallel<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>. This is by far the most time-consuming part of CANAPE, since we have to repeat the calculations many (e.g., hundreds or more) times across the randomized communities to obtain reliable results. Here, we set the number of iterations (<code>n_iterations</code>; i.e., the number of swaps used to produce each randomized community) fairly high because this community matrix is large and includes many zeros; thorough mixing by swapping many times is required to completely randomize the matrix.</p>
<p>We will use a low number of random communities (<code>n_reps</code>) so things finish relatively quickly; you should consider increasing <code>n_reps</code> for a “real” analysis<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>. We will use the <code>curveball</code> randomization algorithm, which maintains species richness and abundance patterns while randomizing species identity <span class="citation">(Strona et al. 2014)</span><a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Set a parallel back-end, with 3 CPUs running simultaneously</span>
<span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>

<span class="co"># Uncomment this to show a progress bar when running cpr_rand_test()</span>
<span class="co"># progressr::handlers(global = TRUE)</span>

<span class="co"># Set a random number generator seed so we get the same results if this is run again</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">071421</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Set a timer</span>
<span class="co"># Run randomization test</span>
<span class="va">acacia_rand_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cpr_rand_test.html">cpr_rand_test</a></span><span class="op">(</span>
  <span class="va">acacia</span><span class="op">$</span><span class="va">comm</span>, <span class="va">acacia</span><span class="op">$</span><span class="va">phy</span>, 
  null_model <span class="op">=</span> <span class="st">"curveball"</span>,
  n_reps <span class="op">=</span> <span class="fl">100</span>, n_iterations <span class="op">=</span> <span class="fl">100000</span>,
  tbl_out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; [1] "Dropping tips from the tree because they are not present in the community data:"</span>
<span class="co">#&gt; [1] "Pararchidendron_pruinosum" "Paraserianthes_lophantha" </span>
<span class="co">#&gt; [3] "saligna"                   "clunies-rossiae"</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># See how long it took</span>
<span class="co">#&gt; 88.745 sec elapsed</span>

<span class="co"># Switch back to sequential (non-parallel) mode</span>
<span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></code></pre></div>
<p>Let’s take a peek at the output.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acacia_rand_res</span>
<span class="co">#&gt; # A tibble: 3,037 × 55</span>
<span class="co">#&gt;    site    pd_obs pd_rand_mean pd_rand_sd pd_obs_z pd_obs_c_upper pd_obs_c_lower</span>
<span class="co">#&gt;    &lt;chr&gt;    &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt;  1 '-1025… 0.0145       0.0224    0.00451 -1.76                 2             98</span>
<span class="co">#&gt;  2 '-1025… 0.0383       0.0492    0.00792 -1.37                 8             92</span>
<span class="co">#&gt;  3 '-1025… 0.0379       0.0380    0.00697 -0.00999             54             46</span>
<span class="co">#&gt;  4 '-1025… 0.0571       0.0616    0.00777 -0.569               33             67</span>
<span class="co">#&gt;  5 '-1025… 0.0410       0.0415    0.00704 -0.0760              52             48</span>
<span class="co">#&gt;  6 '-1025… 0.0100       0.0103    0.00230 -0.124               55             45</span>
<span class="co">#&gt;  7 '-1025… 0.0188       0.0228    0.00408 -0.977               17             83</span>
<span class="co">#&gt;  8 '-1025… 0.0435       0.0539    0.00725 -1.44                 8             92</span>
<span class="co">#&gt;  9 '-1025… 0.0111       0.0103    0.00232  0.377               80             20</span>
<span class="co">#&gt; 10 '-1025… 0.0905       0.0860    0.0103   0.442               68             32</span>
<span class="co">#&gt; # … with 3,027 more rows, and 48 more variables: pd_obs_q &lt;dbl&gt;,</span>
<span class="co">#&gt; #   pd_obs_p_upper &lt;dbl&gt;, pd_obs_p_lower &lt;dbl&gt;, pd_alt_obs &lt;dbl&gt;,</span>
<span class="co">#&gt; #   pd_alt_rand_mean &lt;dbl&gt;, pd_alt_rand_sd &lt;dbl&gt;, pd_alt_obs_z &lt;dbl&gt;,</span>
<span class="co">#&gt; #   pd_alt_obs_c_upper &lt;dbl&gt;, pd_alt_obs_c_lower &lt;dbl&gt;, pd_alt_obs_q &lt;dbl&gt;,</span>
<span class="co">#&gt; #   pd_alt_obs_p_upper &lt;dbl&gt;, pd_alt_obs_p_lower &lt;dbl&gt;, rpd_obs &lt;dbl&gt;,</span>
<span class="co">#&gt; #   rpd_rand_mean &lt;dbl&gt;, rpd_rand_sd &lt;dbl&gt;, rpd_obs_z &lt;dbl&gt;,</span>
<span class="co">#&gt; #   rpd_obs_c_upper &lt;dbl&gt;, rpd_obs_c_lower &lt;dbl&gt;, rpd_obs_q &lt;dbl&gt;, …</span></code></pre></div>
<p><code><a href="../reference/cpr_rand_test.html">cpr_rand_test()</a></code> produces <strong>a lot</strong> of columns. Here, <code>pd_obs</code> is the observed value of phylogenetic diversity (PD). Other columns starting with <code>pd</code> refer to aspects of the randomization: <code>pd_rand_mean</code> is the mean PD across the random communities, <code>pd_rand_sd</code> is the standard deviation of PD across the random communities, <code>pd_obs_z</code> is the standard effect size of PD, etc.</p>
<p>For details about what each column means, see <code><a href="../reference/cpr_rand_test.html">cpr_rand_test()</a></code>.</p>
</div>
<div id="classify-endemism" class="section level2">
<h2 class="hasAnchor">
<a href="#classify-endemism" class="anchor"></a>Classify endemism</h2>
<p>The next step in CANAPE is to classify types of endemism. For a full description, see <span class="citation">Mishler et al. (2014)</span>. In short, this defines endemic regions based on combinations of the <em>p</em>-values of phylogenetic endemism (PE; <code>pe_obs</code>) and PE measured on an alternative tree with all branch lengths equal (<code>pe_alt</code>). Here is a summary <a href="http://biodiverse-analysis-software.blogspot.com/2014/11/canape-categorical-analysis-of-palaeo.html">borrowed from the biodiverse blog</a>, modified to use the variables as they are defined in <code>canaper</code>:</p>
<ol style="list-style-type: decimal">
<li>If either <code>pe_obs</code> or <code>pe_alt_obs</code> are significantly high then we look for paleo- or neo-endemism
<ol style="list-style-type: lower-alpha">
<li>If <code>rpe_obs</code> is significantly high then we have palaeo-endemism</li>
<li>Else if <code>rpe_obs</code> is significantly low then we have neo-endemism</li>
<li>Else we have mixed age endemism, in which case
<ol style="list-style-type: lower-roman">
<li>If both <code>pe_obs</code> and <code>pe_alt_obs</code> are highly significant (<em>p</em> &lt; 0.01) then we have super endemism (high in both paleo and neo)</li>
<li>Else we have mixed (some mixture of paleo, neo and nonendemic)</li>
</ol>
</li>
</ol>
</li>
<li>Else if neither <code>pe_obs</code> or <code>pe_alt_obs</code>are significantly high then we have a non-endemic cell</li>
</ol>
<p><code><a href="../reference/cpr_classify_endem.html">cpr_classify_endem()</a></code> carries this out automatically on the results from <code><a href="../reference/cpr_rand_test.html">cpr_rand_test()</a></code>, adding a factor called <code>endem_type</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acacia_canape</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cpr_classify_endem.html">cpr_classify_endem</a></span><span class="op">(</span><span class="va">acacia_rand_res</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">acacia_canape</span><span class="op">$</span><span class="va">endem_type</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;           mixed             neo not significant           paleo           super </span>
<span class="co">#&gt;             175               9            2786              34              33</span></code></pre></div>
</div>
<div id="classify-signficance" class="section level2">
<h2 class="hasAnchor">
<a href="#classify-signficance" class="anchor"></a>Classify signficance</h2>
<p>A similar function to <code><a href="../reference/cpr_classify_endem.html">cpr_classify_endem()</a></code> is available to classify significance of the randomization test, <code><a href="../reference/cpr_classify_signif.html">cpr_classify_signif()</a></code>. Note that both of these take a <code>data.frame</code> as input and return a <code>data.frame</code> as output, so they are “pipe-friendly”. The second argument of <code><a href="../reference/cpr_classify_signif.html">cpr_classify_signif()</a></code> is the name of the biodiversity metric that you want to classify. This will add a column <code>*_signif</code> with the significance relative to the random distribution for that metric. For example, <code><a href="../reference/cpr_classify_signif.html">cpr_classify_signif(df, "pd")</a></code> will add the <code>pd_signif</code> column to <code>df</code>.</p>
<p>We can chain them together as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acacia_canape</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/cpr_classify_endem.html">cpr_classify_endem</a></span><span class="op">(</span><span class="va">acacia_rand_res</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/cpr_classify_signif.html">cpr_classify_signif</a></span><span class="op">(</span><span class="st">"pd"</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/cpr_classify_signif.html">cpr_classify_signif</a></span><span class="op">(</span><span class="st">"rpd"</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/cpr_classify_signif.html">cpr_classify_signif</a></span><span class="op">(</span><span class="st">"pe"</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/cpr_classify_signif.html">cpr_classify_signif</a></span><span class="op">(</span><span class="st">"rpe"</span><span class="op">)</span>

<span class="co"># Take a look at one of the significance classifications:</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">acacia_canape</span><span class="op">$</span><span class="va">pd_signif</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;          &lt; 0.01         &lt; 0.025         &gt; 0.975          &gt; 0.99 not significant </span>
<span class="co">#&gt;             301             219              32              22            2463</span></code></pre></div>
</div>
<div id="visualize-results" class="section level2">
<h2 class="hasAnchor">
<a href="#visualize-results" class="anchor"></a>Visualize results</h2>
<p>With the randomizations and classification steps taken care of, we can now visualize the results to see how they match up with those of <span class="citation">Mishler et al. (2014)</span>.</p>
<p>Note that the results will not be identical because we have used a different randomization algorithm from the paper and because of stochasticity in the random values.</p>
<p>Here is Figure 2, showing the results of the randomization test for PE, RPE, PE, and RPE:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Fist do some data wrangling to make the results easier to plot (add lat/long columns)</span>
<span class="va">acacia_canape</span> <span class="op">&lt;-</span> <span class="va">acacia_canape</span> |&gt;
  <span class="fu">separate</span><span class="op">(</span><span class="va">site</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"long"</span>, <span class="st">"lat"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">":"</span><span class="op">)</span> |&gt; 
  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">long</span>, <span class="va">lat</span><span class="op">)</span>, <span class="va">parse_number</span><span class="op">)</span><span class="op">)</span>

<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">acacia_canape</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, fill <span class="op">=</span> <span class="va">pd_signif</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># cpr_signif_cols is a color palette in canaper for significance colors</span>
  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">cpr_signif_cols</span>, name <span class="op">=</span> <span class="st">"Phylogenetic diversity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>title.position <span class="op">=</span> <span class="st">"top"</span>, label.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">acacia_canape</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, fill <span class="op">=</span> <span class="va">rpd_signif</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">cpr_signif_cols</span>, name <span class="op">=</span> <span class="st">"Relative phylogenetic diversity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>title.position <span class="op">=</span> <span class="st">"top"</span>, label.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span>

<span class="va">c</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">acacia_canape</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, fill <span class="op">=</span> <span class="va">pe_signif</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">cpr_signif_cols</span>, name <span class="op">=</span> <span class="st">"Phylogenetic endemism"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>title.position <span class="op">=</span> <span class="st">"top"</span>, label.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span>

<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">acacia_canape</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, fill <span class="op">=</span> <span class="va">rpe_signif</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">cpr_signif_cols</span>, name <span class="op">=</span> <span class="st">"Relative phylogenetic endemism"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>title.position <span class="op">=</span> <span class="st">"top"</span>, label.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span>

<span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">c</span> <span class="op">+</span> <span class="va">d</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"a"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></code></pre></div>
<p><img src="canape_files/figure-html/mishler2014-fig2-1.png" width="672"></p>
<p>And here is Figure 3, showing the results of CANAPE:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">acacia_canape</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, fill <span class="op">=</span> <span class="va">endem_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># cpr_endem_cols is a color palette in canaper for endemism colors</span>
  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">cpr_endem_cols</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>title.position <span class="op">=</span> <span class="st">"top"</span>, label.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">acacia_canape</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">pe_alt_obs</span>, y <span class="op">=</span> <span class="va">pe_obs</span>, color <span class="op">=</span> <span class="va">endem_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">cpr_endem_cols</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Phylogenetic endemism on comparison tree"</span>,
    y <span class="op">=</span> <span class="st">"Phylogenetic endemism on actual tree"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>

<span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"a"</span><span class="op">)</span></code></pre></div>
<p><img src="canape_files/figure-html/mishler2014-fig3-1.png" width="576"></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Mishler2014">
<p>Mishler, Brent D, Nunzio Knerr, Carlos E. González-Orozco, Andrew H. Thornhill, Shawn W. Laffan, and Joseph T. Miller. 2014. “Phylogenetic Measures of Biodiversity and Neo- and Paleo-Endemism in Australian Acacia.” <em>Nature Communications</em> 5: 4473. <a href="https://doi.org/10.1038/ncomms5473">https://doi.org/10.1038/ncomms5473</a>.</p>
</div>
<div id="ref-Strona2014">
<p>Strona, Giovanni, Domenico Nappo, Francesco Boccacci, Simone Fattorini, and Jesus San-Miguel-Ayanz. 2014. “A Fast and Unbiased Procedure to Randomize Ecological Binary Matrices with Fixed Row and Column Totals.” <em>Nature Communications</em> 5 (1): 4114. <a href="https://doi.org/10.1038/ncomms5114">https://doi.org/10.1038/ncomms5114</a>.</p>
</div>
<div id="ref-Strona2018">
<p>Strona, Giovanni, Werner Ulrich, and Nicholas J. Gotelli. 2018. “Bi‐dimensional Null Model Analysis of Presence‐absence Binary Matrices.” <em>Ecology</em> 99 (1): 103–15. <a href="https://doi.org/10.1002/ecy.2043">https://doi.org/10.1002/ecy.2043</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>You might think the dataset is all zeros, but that is not the case. It is just very sparse.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>32 as of <code>vegan</code> v2.5.7, though not all may be applicable.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>For a good review of randomization algorithms and their implications for analysis results, see <span class="citation">Strona, Ulrich, and Gotelli (2018)</span><a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>For more information on how and when to use parallel computing in <code>canaper</code>, <a href="https://joelnitta.github.io/canaper/articles/parallel.html">see the “Parallel computing” vignette</a><a href="#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>For more information on setting the appropriate number of iterations and replicates, <a href="https://joelnitta.github.io/canaper/articles/how-many-rand.html">see the “How many randomizations?” vigenette</a>.<a href="#fnref5" class="footnote-back">↩︎</a></p></li>
<li id="fn6"><p><code>curveball</code> is similar to <code>swap</code> but runs much faster so I chose it for this large dataset.<a href="#fnref6" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Joel H. Nitta.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
