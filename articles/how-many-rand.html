<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How many randomizations? • canaper</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How many randomizations?">
<meta property="og:description" content="canaper">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">canaper</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/canape.html">CANAPE example</a>
    </li>
    <li>
      <a href="../articles/how-many-rand.html">How many randomizations?</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Parallel computing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/joelnitta/canaper/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="how-many-rand_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How many randomizations?</h1>
                        <h4 class="author">Joel H. Nitta</h4>
            
            <h4 class="date">20 October, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/joelnitta/canaper/blob/master/vignettes/how-many-rand.Rmd"><code>vignettes/how-many-rand.Rmd</code></a></small>
      <div class="hidden name"><code>how-many-rand.Rmd</code></div>

    </div>

    
    
<p>A central part of CANAPE is comparing observed values with randomizations. It is up to the user to set the number of randomizations… but how does one know if the number of randomizations is sufficient?</p>
<p>(<strong>This vignette assumes a basic understanding of CANAPE, community data matrices, and randomizations</strong>. If you aren’t familiar with any of these, you should probably see the <a href="https://joelnitta.github.io/canaper/articles/canape.html">the CANAPE example vignette</a> first).</p>
<div id="a-word-about-randomization-algorithms" class="section level2">
<h2 class="hasAnchor">
<a href="#a-word-about-randomization-algorithms" class="anchor"></a>A word about randomization algorithms</h2>
<p>There is a rich literature on choice of randomization algorithms in ecology (see references below for a taste), so I won’t go into this much, but choice of algorithm can have a large impact on results, so it’s important to understand.</p>
<p>The function used by <code>canaper</code> for randomizations, <code><a href="https://rdrr.io/pkg/picante/man/randomizeSample.html">picante::randomizeMatrix()</a></code>, offers four different algorithms to choose from<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>: <code>frequecy</code>, <code>richness</code>, <code>independentswap</code> <span class="citation">(Gotelli 2000)</span>, and <code>trialswap</code> <span class="citation">(Miklós and Podani 2004)</span>.</p>
<p><code>frequency</code> and <code>richness</code> are fairly simple: they randomize the community matrix by either shuffling abundances within species (<code>frequency</code>; preserves column totals) or shuffling abundances within samples (<code>richness</code>; preserves row totals). They don’t require setting <code>n_iterations</code> since a single randomization is generated by just randomizing everything within these constraints once.</p>
<p><code>independentswap</code> and <code>trialswap</code> are more sophisticated, in that they preserve the row <strong>and</strong> column totals while randomizing the data. Both operate by swapping occurrences between pairs of species and sites; one such swap is a single iteration (the <a href="http://biodiverse-analysis-software.blogspot.com/2020/12/biodiverse-now-includes-independent.html">Biodiverse blog has a nice explanation of the algorithm</a>). So they both require a large number of swaps to achieve sufficient randomization. The two algorithms are quite similar, but <code>trialswap</code> modifies <code>independentswap</code> so that it converges to the uniform distribution <span class="citation">(Miklós and Podani 2004)</span>.</p>
<p>In most cases, algorithms like <code>independentswap</code> and <code>trialswap</code> that randomize both columns and rows of the community matrix are preferable over simpler algorithms like <code>frequency</code> and <code>richness</code> <span class="citation">(Connor and Simberloff 1979)</span>, so for this example we will use <code>independentswap</code>.</p>
<p><strong>Important note</strong>: <code>trialswap</code> has been found to produce CANAPE results that greatly differ from both <code>independentswap</code> and the <a href="http://biodiverse-analysis-software.blogspot.com/2020/11/randomisations-how-randstructured.html">randomization algorithm of Biodiverse (<code>rand_structured</code>)</a>. <strong>It is strongly recommended to use <code>independentswap</code>, and not <code>trialswap</code></strong>.</p>
</div>
<div id="replicates-vs--iterations" class="section level2">
<h2 class="hasAnchor">
<a href="#replicates-vs--iterations" class="anchor"></a>Replicates vs. iterations</h2>
<p>Before proceeding, we need to clarify some terminology. <code><a href="../reference/cpr_rand_test.html">cpr_rand_test()</a></code> includes two arguments, <code>n_reps</code> and <code>n_iterations</code>. These sound similar but refer to two very different things.</p>
<p><code>n_reps</code> is the number of random communities to simulate, and is used by all four randomization algorithms. For example, if <code>n_reps</code> is 100, will we be comparing each observed value (e.g., phylogenetic diversity, <code>pd_obs</code>), with 100 random replicates of <code>pd_obs</code>. If <code>n_reps</code> is too low, we will lack sufficiently statistical power to detect patterns in the data.</p>
<p><code>n_iterations</code> is only used by the <code>independentswap</code> and <code>trialswap</code> algorithms. As described above, these algorithms generate a random community by swapping existing cells in the community matrix. In other words, they “mix” the matrix to randomize it. If <code>n_iterations</code> is too low, the randomized matrix won’t be sufficiently mixed, and will still resemble the original matrix.</p>
<p>If either <code>n_reps</code> or <code>n_iterations</code> are set too high, it will take overly long to finish the calculations. So our goal is to set them sufficiently high to achieve proper randomization, but not so high <code><a href="../reference/cpr_rand_test.html">cpr_rand_test()</a></code> never finishes.</p>
</div>
<div id="effect-of-n_iterations" class="section level2">
<h2 class="hasAnchor">
<a href="#effect-of-n_iterations" class="anchor"></a>Effect of <code>n_iterations</code>
</h2>
<p>First, let’s explore the effect of <code>n_iterations</code>. There are various ways to do this, but here I will use a <a href="https://en.wikipedia.org/wiki/Mantel_test">Mantel test</a>, which compares two matrices. Specifically, I will calculate the correlation between a distance matrix based on the original community data and a distance matrix based on the randomized data. I will use <code><a href="https://rdrr.io/pkg/picante/man/randomizeSample.html">picante::randomizeMatrix()</a></code> to generate the random communities, which <code><a href="../reference/cpr_rand_test.html">cpr_rand_test()</a></code> also uses internally<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p>First, let’s load the packages used in this vignette.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joelnitta/canaper">canaper</a></span><span class="op">)</span> <span class="co"># This package</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">picante</span><span class="op">)</span> <span class="co"># For generating random communities</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org">vegan</a></span><span class="op">)</span> <span class="co"># For Mantel test</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/collectivemedia/tictoc">tictoc</a></span><span class="op">)</span> <span class="co"># For timing</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span> <span class="co"># For tidy code</span></code></pre></div>
<p>Next we will test the effects of <code>n_iterations</code>, using the <a href="https://joelnitta.github.io/canaper/reference/biod_example.html">test dataset that comes with <code>canaper</code></a> (and <a href="https://github.com/shawnlaffan/biodiverse/tree/master/data">Biodiverse</a>):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Calculate a distance matrix from the original community data matrix</span>
<span class="va">comm_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/vegdist.html">vegdist</a></span><span class="op">(</span><span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span><span class="op">)</span>

<span class="co"># Set random number seed so the results are reproducible</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span>
<span class="va">dist_test_res</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>
  <span class="co"># Set up a vector from 10 to 10^6 for testing n_iterations</span>
  n_iter <span class="op">=</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">raise_to_power</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>,
  <span class="co"># Make one random community for each value of `n_iter`</span>
  rand_comm <span class="op">=</span> <span class="fu">map</span><span class="op">(</span>
    <span class="va">n_iter</span>, 
    <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/picante/man/randomizeSample.html">randomizeMatrix</a></span><span class="op">(</span>
      <span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span>, 
      null.model <span class="op">=</span> <span class="st">"independentswap"</span>, iterations <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span>,
  <span class="co"># Calculate the distance matrix of each community</span>
  rand_comm_dist <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">rand_comm</span>, <span class="va">vegdist</span><span class="op">)</span>,
  <span class="co"># Run the Mantel text and extract `r` (coefficient value) between</span>
  <span class="co"># each random community and the original community</span>
  mantel_r <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">rand_comm_dist</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/vegan/man/mantel.html">mantel</a></span><span class="op">(</span><span class="va">comm_dist</span>, <span class="va">.</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Plot the results</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">dist_test_res</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">n_iter</span>, y <span class="op">=</span> <span class="va">mantel_r</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"n_iterations"</span>, y <span class="op">=</span> <span class="st">"Mantel r"</span><span class="op">)</span></code></pre></div>
<p><img src="how-many-rand_files/figure-html/test-n-iter-1.png" width="700"></p>
<p>From this, we can see that the original community and the randomized community are correlated up to about 1000 iterations. After that, the correlation coefficient levels off, and doesn’t decrease much further with additional “mixing”.</p>
<p><span class="citation">Miklós and Podani (2004)</span> suggest for their algorithm (<code>trialswap</code>) to use at least twice the number of non-zeros in the community matrix. For our data, that is:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">comm_presabs</span> <span class="op">&lt;-</span> <span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span>
<span class="va">comm_presabs</span><span class="op">[</span><span class="va">comm_presabs</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">comm_presabs</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span>
<span class="co">#&gt; [1] 730</span></code></pre></div>
<p>So that roughly agrees with our plot above.</p>
<p>Note that the number of iterations required <strong>will vary based on the dataset</strong>. It will likely be higher in datasets that are extremely skewed towards a high percentage of presences or absences, since a given swap is unlikely to actually change anything. So I recommend exploring the data as above, or at least checking the “rule of thumb” of <span class="citation">Miklós and Podani (2004)</span>, to determine the minimum number of iterations needed.</p>
<p>Another note: <code><a href="https://rdrr.io/pkg/picante/man/randomizeSample.html">picante::randomizeMatrix()</a></code> is quite fast, even with millions of swaps. So you can probably be comfortable running up to 10^6 or so, but again it will depend on the dataset.</p>
<p>Now that we’ve settled on the number of iterations per random replicate, let’s look into the number of replicates.</p>
</div>
<div id="effect-of-n_reps" class="section level2">
<h2 class="hasAnchor">
<a href="#effect-of-n_reps" class="anchor"></a>Effect of <code>n_reps</code>
</h2>
<p>With randomizations, there is no “right” answer, so we can’t test to see that <code><a href="../reference/cpr_rand_test.html">cpr_rand_test()</a></code> produces the exact answer we’re looking for. Rather, we will check that it starts to <strong>converge on approximately the same result</strong> once <code>n_reps</code> is high enough.</p>
<p>Here, I will compare the percentile of observed phylogenetic diversity relative to random (<code>pd_obs_p_upper</code>, <a href="https://joelnitta.github.io/canaper/articles/canape.html#classify-endemism">one of the values used for calculating endemism type</a>) between pairs of random communities each generated with the same number of replicates<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. I will also time calculations for one of each pair.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Specify a different random seed for each set of randomizations so they give</span>
<span class="co"># different, reproducible results</span>

<span class="co"># First set</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">res_10_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cpr_rand_test.html">cpr_rand_test</a></span><span class="op">(</span>
  <span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span>, <span class="va">biod_example</span><span class="op">$</span><span class="va">phy</span>, 
  null_model <span class="op">=</span> <span class="st">"independentswap"</span>,
  n_iterations <span class="op">=</span> <span class="fl">1000</span>, n_reps <span class="op">=</span> <span class="fl">10</span>, tbl_out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; 6.257 sec elapsed</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">res_100_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cpr_rand_test.html">cpr_rand_test</a></span><span class="op">(</span>
  <span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span>, <span class="va">biod_example</span><span class="op">$</span><span class="va">phy</span>, 
  null_model <span class="op">=</span> <span class="st">"independentswap"</span>,
  n_iterations <span class="op">=</span> <span class="fl">1000</span>, n_reps <span class="op">=</span> <span class="fl">100</span>, tbl_out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; 2.157 sec elapsed</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">res_1000_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cpr_rand_test.html">cpr_rand_test</a></span><span class="op">(</span>
  <span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span>, <span class="va">biod_example</span><span class="op">$</span><span class="va">phy</span>, 
  null_model <span class="op">=</span> <span class="st">"independentswap"</span>,
  n_iterations <span class="op">=</span> <span class="fl">1000</span>, n_reps <span class="op">=</span> <span class="fl">1000</span>, tbl_out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; 19.649 sec elapsed</span>

<span class="co"># Second set</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">67890</span><span class="op">)</span>
<span class="va">res_10_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cpr_rand_test.html">cpr_rand_test</a></span><span class="op">(</span>
  <span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span>, <span class="va">biod_example</span><span class="op">$</span><span class="va">phy</span>,
  null_model <span class="op">=</span> <span class="st">"independentswap"</span>,
  n_iterations <span class="op">=</span> <span class="fl">1000</span>, n_reps <span class="op">=</span> <span class="fl">10</span>, tbl_out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">res_100_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cpr_rand_test.html">cpr_rand_test</a></span><span class="op">(</span>
  <span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span>, <span class="va">biod_example</span><span class="op">$</span><span class="va">phy</span>, 
  null_model <span class="op">=</span> <span class="st">"independentswap"</span>,
  n_iterations <span class="op">=</span> <span class="fl">1000</span>, n_reps <span class="op">=</span> <span class="fl">100</span>, tbl_out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">res_1000_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cpr_rand_test.html">cpr_rand_test</a></span><span class="op">(</span>
  <span class="va">biod_example</span><span class="op">$</span><span class="va">comm</span>, <span class="va">biod_example</span><span class="op">$</span><span class="va">phy</span>, 
  null_model <span class="op">=</span> <span class="st">"independentswap"</span>,
  n_iterations <span class="op">=</span> <span class="fl">1000</span>, n_reps <span class="op">=</span> <span class="fl">1000</span>, tbl_out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>Next, plot the results.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We will make the same plot repeatedly, so write</span>
<span class="co"># a quick function to avoid lots of copying and pasting</span>
<span class="va">plot_comp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">res_1</span>, <span class="va">res_2</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">left_join</span><span class="op">(</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">res_1</span>, <span class="va">site</span>, pd_obs_p_upper_1 <span class="op">=</span> <span class="va">pd_obs_p_upper</span><span class="op">)</span>, 
  <span class="fu">select</span><span class="op">(</span><span class="va">res_2</span>, <span class="va">site</span>, pd_obs_p_upper_2 <span class="op">=</span> <span class="va">pd_obs_p_upper</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"site"</span><span class="op">)</span> |&gt;
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">pd_obs_p_upper_1</span>, y <span class="op">=</span> <span class="va">pd_obs_p_upper_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">plot_comp</span><span class="op">(</span><span class="va">res_10_1</span>, <span class="va">res_10_2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"10 replicates"</span><span class="op">)</span></code></pre></div>
<p><img src="how-many-rand_files/figure-html/n-reps-plots-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">plot_comp</span><span class="op">(</span><span class="va">res_100_1</span>, <span class="va">res_100_2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"100 replicates"</span><span class="op">)</span></code></pre></div>
<p><img src="how-many-rand_files/figure-html/n-reps-plots-2.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">plot_comp</span><span class="op">(</span><span class="va">res_1000_1</span>, <span class="va">res_1000_2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"1000 replicates"</span><span class="op">)</span></code></pre></div>
<p><img src="how-many-rand_files/figure-html/n-reps-plots-3.png" width="700"></p>
<p>This visualization shows how the randomization results converge as <code>n_reps</code> increases.</p>
<p>The above plots illustrate convergence for one particular aspect of CANAPE, but what about endemism type itself? We can look at that too.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define a helper function that joins two datasets and calculates % agreement</span>
<span class="co"># on endemism type between them</span>
<span class="va">calc_agree_endem</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_1</span>, <span class="va">df_2</span>, <span class="va">n_reps</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">df_1</span> |&gt; <span class="fu"><a href="../reference/cpr_classify_endem.html">cpr_classify_endem</a></span><span class="op">(</span><span class="op">)</span> |&gt; <span class="fu">select</span><span class="op">(</span><span class="va">site</span>, endem_type_1 <span class="op">=</span> <span class="va">endem_type</span><span class="op">)</span>,
    <span class="va">df_2</span> |&gt; <span class="fu"><a href="../reference/cpr_classify_endem.html">cpr_classify_endem</a></span><span class="op">(</span><span class="op">)</span> |&gt; <span class="fu">select</span><span class="op">(</span><span class="va">site</span>, endem_type_2 <span class="op">=</span> <span class="va">endem_type</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="st">"site"</span>
  <span class="op">)</span> |&gt;
    <span class="fu">mutate</span><span class="op">(</span>agree <span class="op">=</span> <span class="va">endem_type_1</span> <span class="op">==</span> <span class="va">endem_type_2</span><span class="op">)</span> |&gt;
    <span class="fu">summarize</span><span class="op">(</span>agree <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">agree</span><span class="op">)</span>, total <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> |&gt;
    <span class="fu">mutate</span><span class="op">(</span>
      p_agree <span class="op">=</span> <span class="va">agree</span><span class="op">/</span><span class="va">total</span>,
      n_reps <span class="op">=</span> <span class="va">n_reps</span><span class="op">)</span> 
<span class="op">}</span>

<span class="fu">bind_rows</span><span class="op">(</span>
  <span class="fu">calc_agree_endem</span><span class="op">(</span><span class="va">res_10_1</span>, <span class="va">res_10_2</span>, <span class="fl">10</span><span class="op">)</span>,
  <span class="fu">calc_agree_endem</span><span class="op">(</span><span class="va">res_100_1</span>, <span class="va">res_100_2</span>, <span class="fl">100</span><span class="op">)</span>,
  <span class="fu">calc_agree_endem</span><span class="op">(</span><span class="va">res_1000_1</span>, <span class="va">res_1000_2</span>, <span class="fl">1000</span><span class="op">)</span>,
<span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 4</span>
<span class="co">#&gt;   agree total p_agree n_reps</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1   107   127   0.843     10</span>
<span class="co">#&gt; 2   118   127   0.929    100</span>
<span class="co">#&gt; 3   125   127   0.984   1000</span></code></pre></div>
<p>At 1000 replicates, we see &gt; 95% agreement on endemism type between the two randomizations. So here, I would use at least 100, and probably 1000 to be safe.</p>
<p>Of course, another important consideration is <strong>how long</strong> calculations take. You can see that time increases with <code>n_reps</code>, but not exactly in a linear fashion. We don’t have the space to go into benchmarking here, but this illustrates the time / <code>n_reps</code> trade-off<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>.</p>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>In this case (the <a href="https://joelnitta.github.io/canaper/reference/biod_example.html">example dataset</a> that comes with <code>canaper</code>), we see that a minimum of 1000 random replicates with 1000 swapping iterations per replicate is probably needed to attain robust results. I hope this vignette helps you determine the settings to use for your own dataset!</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Connor1979">
<p>Connor, Edward F., and Daniel Simberloff. 1979. “The Assembly of Species Communities: Chance or Competition?” <em>Ecology</em> 60 (6): 1132. <a href="https://doi.org/10/b3kvf7">https://doi.org/10/b3kvf7</a>.</p>
</div>
<div id="ref-Gotelli2000">
<p>Gotelli, Nicholas J. 2000. “Null Model Analysis of Species Co-Occurrence Patterns.” <em>Ecology</em> 81 (9): 2606–21. <a href="https://doi.org/10.2307/177478">https://doi.org/10.2307/177478</a>.</p>
</div>
<div id="ref-Miklos2004">
<p>Miklós, I., and J. Podani. 2004. “Randomization of Presence–Absence Matrices: Comments and New Algorithms.” <em>Ecology</em> 85 (1): 86–92. <a href="https://doi.org/10/br74wj">https://doi.org/10/br74wj</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>An additional algorithm, <code>rand_structured</code> is currently <a href="http://biodiverse-analysis-software.blogspot.com/2020/11/randomisations-how-randstructured.html">only offered in Biodiverse</a>. <a href="http://biodiverse-analysis-software.blogspot.com/2020/12/biodiverse-now-includes-independent.html">Benchmark tests indicate</a> that <code>rand_structured</code> is faster than the <code>picante</code> swapping algorithms.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>The <code>iterations</code> argument of <code><a href="https://rdrr.io/pkg/picante/man/randomizeSample.html">picante::randomizeMatrix()</a></code> is equivalent to the <code>n_iterations</code> argument of <code><a href="../reference/cpr_rand_test.html">cpr_rand_test()</a></code>).<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Other values based on the randomizations could be checked too (e.g., values ending in <code>_obs_z</code>, <code>_rand_mean</code>, or <code>_rand_sd</code>).<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>You can of course speed things up with parallelization. For details, see <a href="https://joelnitta.github.io/canaper/articles/canape.html#randomization-test">the CANAPE example vignette</a>.<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Joel H. Nitta.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
